# Kubernetes Secrets Management for Blockchain
# Production-ready secret handling with encryption and rotation

apiVersion: v1
kind: Secret
metadata:
  name: blockchain-tls-certs
  namespace: vital-blockchain
  labels:
    app: vital-blockchain
    component: security
type: kubernetes.io/tls
data:
  # TLS certificate (base64 encoded PEM)
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZhekNDQTFPZ0F3SUJBZ0lVRXhhbXBsZUNlcnRpZmljYXRlRGF0YUhlcmUKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  # TLS private key (base64 encoded PEM)
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRREV4YW1wbGVLZXlEYXRhCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
  # CA certificate (base64 encoded PEM)
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZhekNDQTFPZ0F3SUJBZ0lVRXhhbXBsZUNBQ2VydGlmaWNhdGVEYXRhSGVyZQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==

---
apiVersion: v1
kind: Secret
metadata:
  name: blockchain-validator-keys
  namespace: vital-blockchain
  labels:
    app: vital-blockchain
    component: consensus
type: Opaque
data:
  # Validator Ed25519 private keys (base64 encoded)
  validator-0-key: dmFsaWRhdG9yLTAtcHJpdmF0ZS1rZXktZXhhbXBsZS1kYXRhLWhlcmUtYmFzZTY0LWVuY29kZWQ=
  validator-1-key: dmFsaWRhdG9yLTEtcHJpdmF0ZS1rZXktZXhhbXBsZS1kYXRhLWhlcmUtYmFzZTY0LWVuY29kZWQ=
  validator-2-key: dmFsaWRhdG9yLTItcHJpdmF0ZS1rZXktZXhhbXBsZS1kYXRhLWhlcmUtYmFzZTY0LWVuY29kZWQ=

---
apiVersion: v1
kind: Secret
metadata:
  name: blockchain-hsm-config
  namespace: vital-blockchain
  labels:
    app: vital-blockchain
    component: hsm
type: Opaque
data:
  # AWS KMS configuration
  aws-region: dXMtZWFzdC0x  # us-east-1
  aws-access-key-id: QUtJQUVYQU1QTEVBQ0NFU1NLRVlJRA==
  aws-secret-access-key: d0phbHJYVXRuRkVNSS9LN01ERU5HL2JQeFJmaUNZRVhBTVBMRUtFWQ==
  aws-kms-key-id: YXJuOmF3czprbXM6dXMtZWFzdC0xOjEyMzQ1Njc4OTAxMjprZXkvZXhhbXBsZS1rZXktaWQ=
  
  # Azure Key Vault configuration
  azure-vault-url: aHR0cHM6Ly9teXZhdWx0LnZhdWx0LmF6dXJlLm5ldA==
  azure-tenant-id: ZXhhbXBsZS10ZW5hbnQtaWQtaGVyZQ==
  azure-client-id: ZXhhbXBsZS1jbGllbnQtaWQtaGVyZQ==
  azure-client-secret: ZXhhbXBsZS1jbGllbnQtc2VjcmV0LWhlcmU=
  
  # HashiCorp Vault configuration
  vault-address: aHR0cDovL3ZhdWx0LnZpdGFsLmludGVybmFsOjgyMDA=
  vault-token: cy5leGFtcGxlLnZhdWx0LXRva2VuLWhlcmU=
  vault-namespace: dml0YWwtYmxvY2tjaGFpbg==

---
apiVersion: v1
kind: Secret
metadata:
  name: blockchain-database-creds
  namespace: vital-blockchain
  labels:
    app: vital-blockchain
    component: storage
type: Opaque
data:
  # RocksDB encryption key
  rocksdb-encryption-key: ZXhhbXBsZS1yb2Nrc2RiLWVuY3J5cHRpb24ta2V5LTI1Ni1iaXQtYmFzZTY0
  # Backup encryption key
  backup-encryption-key: ZXhhbXBsZS1iYWNrdXAtZW5jcnlwdGlvbi1rZXktMjU2LWJpdC1iYXNlNjQ=
  # Database password (if using external DB)
  db-password: ZXhhbXBsZS1kYXRhYmFzZS1wYXNzd29yZC1oZXJl

---
apiVersion: v1
kind: Secret
metadata:
  name: blockchain-monitoring-creds
  namespace: vital-blockchain
  labels:
    app: vital-blockchain
    component: monitoring
type: Opaque
data:
  # Prometheus credentials
  prometheus-username: YWRtaW4=
  prometheus-password: cHJvbWV0aGV1cy1wYXNzd29yZC1leGFtcGxl
  # Grafana credentials
  grafana-admin-password: Z3JhZmFuYS1hZG1pbi1wYXNzd29yZC1leGFtcGxl
  # Slack webhook for alerts
  slack-webhook-url: aHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvVDAwMDAwMDAwL0IwMDAwMDAwMC94eHh4eHh4eHh4eHh4eHh4eHh4eA==

---
# SealedSecret for production (encrypted at rest)
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: blockchain-production-secrets
  namespace: vital-blockchain
spec:
  encryptedData:
    # These are encrypted using kubeseal and can only be decrypted by the cluster
    validator-master-key: AgBxxx...encrypted-data-here...xxxYQ==
    hsm-master-password: AgByyy...encrypted-data-here...yyyZR==
    root-ca-key: AgBzzz...encrypted-data-here...zzzAS==
  template:
    metadata:
      name: blockchain-production-secrets
      namespace: vital-blockchain
    type: Opaque

---
# External Secrets Operator configuration (for AWS Secrets Manager / Vault)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: vital-blockchain
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: blockchain-sa

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: blockchain-external-secrets
  namespace: vital-blockchain
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: blockchain-runtime-secrets
    creationPolicy: Owner
  data:
    - secretKey: validator-keys
      remoteRef:
        key: vital/blockchain/validator-keys
    - secretKey: tls-certificates
      remoteRef:
        key: vital/blockchain/tls-certs
    - secretKey: hsm-credentials
      remoteRef:
        key: vital/blockchain/hsm-creds

---
# Secret rotation CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-rotation
  namespace: vital-blockchain
spec:
  schedule: "0 2 * * 0"  # Every Sunday at 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: blockchain-sa
          containers:
          - name: rotate-secrets
            image: vital/secret-rotator:latest
            env:
            - name: ROTATION_TYPE
              value: "validator-keys"
            - name: VAULT_ADDR
              valueFrom:
                secretKeyRef:
                  name: blockchain-hsm-config
                  key: vault-address
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: blockchain-hsm-config
                  key: vault-token
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting secret rotation..."
              # Rotate validator keys
              /app/rotate-validator-keys.sh
              # Rotate TLS certificates if expiring soon
              /app/check-and-rotate-tls.sh
              # Update secrets in Kubernetes
              /app/update-k8s-secrets.sh
              echo "Secret rotation completed"
          restartPolicy: OnFailure

---
# RBAC for secret management
apiVersion: v1
kind: ServiceAccount
metadata:
  name: blockchain-sa
  namespace: vital-blockchain
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/VitalBlockchainSecretsRole

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-manager
  namespace: vital-blockchain
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets", "secretstores"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: blockchain-secret-manager
  namespace: vital-blockchain
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: secret-manager
subjects:
- kind: ServiceAccount
  name: blockchain-sa
  namespace: vital-blockchain
