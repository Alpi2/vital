cmake_minimum_required(VERSION 3.20)
project(VitalStreamDICOMService VERSION 1.0.0 LANGUAGES CXX)

# C++ Standard and Configuration
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Build type configuration
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release)
endif()

message(STATUS "Building VitalStream DICOM Service in ${CMAKE_BUILD_TYPE} mode")

# Compiler options
set(COMMON_FLAGS "-Wall -Wextra -Wpedantic")
set(DEBUG_FLAGS "-g -O0 -DDEBUG")
set(RELEASE_FLAGS "-O3 -DNDEBUG -march=native")

# Find required packages using pkg-config to avoid conflicts
find_package(PkgConfig REQUIRED)

# Find packages
pkg_check_modules(PROTOBUF REQUIRED protobuf)
pkg_check_modules(GRPC REQUIRED grpc++)
find_package(DCMTK REQUIRED)
find_package(Boost REQUIRED COMPONENTS filesystem system thread)
find_package(spdlog REQUIRED)
find_package(OpenSSL REQUIRED)
find_package(UUID REQUIRED)

# Package status reporting
if(DCMTK_FOUND)
    message(STATUS "‚úÖ DCMTK found: ${DCMTK_VERSION}")
else()
    message(FATAL_ERROR "‚ùå DCMTK not found - required for DICOM processing")
endif()

message(STATUS "‚úÖ Protobuf: ${PROTOBUF_VERSION}")
message(STATUS "‚úÖ gRPC: ${GRPC_VERSION}")

# Proto files configuration
set(PROTO_FILES
    ../protos/dicom/v1/dicom_service.proto
    ../protos/common/v1/common.proto
)

# Generate protobuf and gRPC code
message(STATUS "üîß Generating protobuf and gRPC code...")

set(PROTO_GENERATED_SOURCES)
set(PROTO_GENERATED_HEADERS)

foreach(proto_file ${PROTO_FILES})
    get_filename_component(proto_name ${proto_file} NAME_WE)
    
    # Generate protobuf
    add_custom_command(
        OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/${proto_name}.pb.h
               ${CMAKE_CURRENT_BINARY_DIR}/${proto_name}.pb.cc
        COMMAND ${PROTOBUF_PROTOC_EXECUTABLE}
        ARGS --cpp_out=${CMAKE_CURRENT_BINARY_DIR}
             --proto_path=${CMAKE_CURRENT_SOURCE_DIR}/../protos
             ${proto_file}
        DEPENDS ${proto_file}
        COMMENT "Generating protobuf for ${proto_name}"
    )
    
    list(APPEND PROTO_GENERATED_HEADERS ${CMAKE_CURRENT_BINARY_DIR}/${proto_name}.pb.h)
    list(APPEND PROTO_GENERATED_SOURCES ${CMAKE_CURRENT_BINARY_DIR}/${proto_name}.pb.cc)
    
    # Generate gRPC
    add_custom_command(
        OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/${proto_name}.grpc.pb.h
               ${CMAKE_CURRENT_BINARY_DIR}/${proto_name}.grpc.pb.cc
        COMMAND ${GRPC_CPP_PLUGIN}
        ARGS --grpc_out=${CMAKE_CURRENT_BINARY_DIR}
             --proto_path=${CMAKE_CURRENT_SOURCE_DIR}/../protos
             ${proto_file}
        DEPENDS ${proto_file}
        COMMENT "Generating gRPC for ${proto_name}"
    )
    
    list(APPEND PROTO_GENERATED_HEADERS ${CMAKE_CURRENT_BINARY_DIR}/${proto_name}.grpc.pb.h)
    list(APPEND PROTO_GENERATED_SOURCES ${CMAKE_CURRENT_BINARY_DIR}/${proto_name}.grpc.pb.cc)
endforeach()

# Set generated files as source variables
set(PROTO_SRCS ${PROTO_GENERATED_SOURCES})
set(GRPC_SRCS ${PROTO_GENERATED_SOURCES})

# Source files
set(SOURCES
    src/main.cpp
    src/dicom_service_impl.cpp
    src/waveform_extractor.cpp
    src/storage_manager.cpp
    src/audit_logger.cpp
    src/health_service.cpp
    ${PROTO_SRCS}
    ${GRPC_SRCS}
)

# Header files
set(HEADERS
    include/dicom_service_impl.h
    include/waveform_extractor.h
    include/storage_manager.h
    include/audit_logger.h
    include/health_service.h
)

# Create executable
add_executable(dicom_service ${SOURCES} ${HEADERS})

# Target-specific include directories
target_include_directories(dicom_service
    PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/include
        ${CMAKE_CURRENT_BINARY_DIR}
        ${DCMTK_INCLUDE_DIRS}
        ${PROTOBUF_INCLUDE_DIRS}
        ${GRPC_INCLUDE_DIRS}
)

# Compiler-specific options
target_compile_options(dicom_service
    PRIVATE
        ${COMMON_FLAGS}
        $<$<CONFIG:Debug>:${DEBUG_FLAGS}>
        $<$<CONFIG:Release>:${RELEASE_FLAGS}>
)

# Link libraries
target_link_libraries(dicom_service
    PRIVATE
        # Protobuf and gRPC
        ${PROTOBUF_LIBRARIES}
        ${GRPC_LIBRARIES}
        
        # DICOM processing
        ${DCMTK_LIBRARIES}
        
        # System libraries
        Boost::filesystem
        Boost::system
        Boost::thread
        
        # Logging
        spdlog::spdlog
        
        # Security
        OpenSSL::SSL
        OpenSSL::Crypto
        
        # Utilities
        ${CMAKE_DL_LIBS}
        pthread
        ${UUID_LIBRARIES}
)

# Platform-specific libraries
if(UNIX AND NOT APPLE)
    target_link_libraries(dicom_service PRIVATE rt)
endif()

# Installation configuration
include(GNUInstallDirs)

install(TARGETS dicom_service
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
)

install(FILES ${HEADERS}
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/vitalstream/dicom
)

# Testing configuration
enable_testing()

# Add Google Test if available
find_package(GTest QUIET)
if(GTest_FOUND)
    message(STATUS "‚úÖ Google Test found - enabling unit tests")
    
    # Test executable
    add_executable(dicom_service_tests
        tests/test_waveform_extractor.cpp
        ${PROTO_SRCS}
        ${GRPC_SRCS}
    )
    
    target_link_libraries(dicom_service_tests
        PRIVATE
            GTest::gtest
            GTest::gtest_main
            ${PROTOBUF_LIBRARIES}
            ${GRPC_LIBRARIES}
            ${DCMTK_LIBRARIES}
            spdlog::spdlog
            Threads::Threads
    )
    
    # Add test to CTest
    add_test(NAME DICOMServiceUnitTests COMMAND dicom_service_tests)
    
    # Set test properties
    set_tests_properties(DICOMServiceUnitTests PROPERTIES
        TIMEOUT 300
        WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
    )
else()
    message(WARNING "‚ö†Ô∏è Google Test not found - unit tests disabled")
endif()

# Print configuration summary
message(STATUS "")
message(STATUS "üè• VitalStream DICOM Service Configuration Summary:")
message(STATUS "   Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "   C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "   Install Prefix: ${CMAKE_INSTALL_PREFIX}")
message(STATUS "   Source Directory: ${CMAKE_CURRENT_SOURCE_DIR}")
message(STATUS "   Binary Directory: ${CMAKE_CURRENT_BINARY_DIR}")
message(STATUS "")
message(STATUS "üì¶ Dependencies:")
message(STATUS "   DCMTK: ${DCMTK_VERSION}")
message(STATUS "   Protobuf: ${PROTOBUF_VERSION}")
message(STATUS "   gRPC: ${GRPC_VERSION}")
message(STATUS "   Boost: ${Boost_VERSION}")
message(STATUS "   spdlog: ${spdlog_VERSION}")
message(STATUS "")
message(STATUS "üîß Features:")
message(STATUS "   Unit Tests: ${GTEST_FOUND}")
message(STATUS "")
